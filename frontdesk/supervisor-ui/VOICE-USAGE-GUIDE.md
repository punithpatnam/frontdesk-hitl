# ğŸ¤ LiveKit Voice Integration - User Guide

## âœ… Voice Feature Now Enabled!

The LiveKit panel now has **full voice integration** with real-time audio communication.

---

## ğŸš€ How to Use Voice

### Step 1: Open the Application
Navigate to http://localhost:5173/

### Step 2: Locate the LiveKit Panel
The voice controls are in the **top navigation bar** (TopNav component)

### Step 3: Configure Connection
- **Identity**: Enter your name/identifier (e.g., "supervisor-1")
- **Room**: Enter the LiveKit room name (e.g., "frontdesk-demo")

### Step 4: Join Voice Room
1. Click **"ğŸ¤ Join Voice Room"** button
2. Browser will request **microphone permission** - click **Allow**
3. Wait for connection (you'll see "ğŸ¤ Connected â€¢ Room: frontdesk-demo")

### Step 5: Start Talking!
- Your microphone is automatically enabled
- The agent in the room will hear you
- You will hear the agent's voice through your speakers

---

## ğŸ›ï¸ Voice Controls

### Join Voice Room (ğŸ¤)
- Connects to LiveKit server using backend token
- Enables your microphone
- Subscribes to agent's audio

### Leave (ğŸ“)
- Disconnects from room
- Stops microphone
- Clears connection

### Mute (ğŸ¤ / ğŸ”‡)
- **Green background** = Microphone ON
- **Red background** = Microphone MUTED
- Toggle anytime during call

---

## ğŸ”Š Audio Features Implemented

### Microphone (Your Voice)
âœ… Automatic microphone capture on join  
âœ… Mute/unmute toggle  
âœ… Audio published to LiveKit room  
âœ… Agent can hear you in real-time  

### Speaker (Agent's Voice)
âœ… Automatic subscription to agent's audio tracks  
âœ… Audio attached to hidden `<audio>` element  
âœ… Auto-play agent responses  
âœ… Real-time voice streaming  

### Connection Management
âœ… Connection state tracking  
âœ… Automatic reconnection on network issues  
âœ… Visual feedback (Connected/Reconnecting)  
âœ… Participant join/leave events  

---

## ğŸ¯ What Happens When You Join

```
1. Click "Join Voice Room"
   â†“
2. Frontend calls backend: GET /livekit/token?identity=...&room=...
   â†“
3. Backend returns: { token, url, identity, room }
   â†“
4. Frontend creates LiveKit Room instance
   â†“
5. Connects to LiveKit server with token
   â†“
6. Enables microphone (publishes audio track)
   â†“
7. Subscribes to remote audio tracks (agent)
   â†“
8. You can talk and hear the agent!
```

---

## ğŸ› Troubleshooting

### Problem: "Microphone permission denied"
**Solution:**
- Check browser permissions (Settings â†’ Privacy â†’ Microphone)
- Reload page and try again
- Make sure you're on HTTPS or localhost

### Problem: "Can't hear agent"
**Solution:**
1. Check speaker volume
2. Verify agent is connected to the room
3. Look for "Track subscribed: audio" in browser console (F12)
4. Try clicking page if autoplay is blocked

### Problem: "Connection failed"
**Solution:**
1. Verify backend is running (http://localhost:8000)
2. Check that LiveKit server is running on backend
3. Look at browser console for error details
4. Verify token endpoint returns valid data

### Problem: "Audio playback blocked"
**Solution:**
- Browser may block autoplay
- Click anywhere on the page to enable audio
- You'll see: "ğŸ”Š Click anywhere to enable audio playback"

---

## ğŸ” Debugging Tips

### Open Browser Console (F12)
Look for these log messages:

**âœ… Success Messages:**
```
âœ… Connected to LiveKit room
ğŸ™ï¸ Microphone enabled
ğŸ“» Track subscribed: audio from agent-voice
ğŸ”Š Agent audio track attached and playing
```

**âŒ Error Messages:**
```
âŒ Failed to join room: [error details]
Audio autoplay failed: [error details]
```

### Check Connection State
The status indicator shows:
- **ğŸ¤ Connected** (green) = Voice working
- **ğŸ”„ Reconnecting** (gray) = Temporary issue
- No message = Not connected

### Verify Backend Token
Test token endpoint manually:
```bash
curl "http://localhost:8000/livekit/token?identity=test&room=demo"
```

Should return:
```json
{
  "token": "eyJhbGc...",
  "url": "wss://livekit-server:7880",
  "identity": "test",
  "room": "demo"
}
```

---

## ğŸ“‹ Voice Feature Checklist

Before using voice, ensure:

- [ ] Backend is running (`http://localhost:8000`)
- [ ] LiveKit server is running on backend
- [ ] Frontend dev server is running (`http://localhost:5173`)
- [ ] Browser supports WebRTC (Chrome, Firefox, Edge, Safari)
- [ ] Microphone is connected
- [ ] Speakers/headphones are connected
- [ ] Microphone permissions granted

---

## ğŸ™ï¸ Text-Based "Ask Question" Feature

In addition to voice, there's a **text-based HITL demonstration**:

1. Join voice room first
2. Enter **Customer ID** (e.g., "demo-1")
3. Type a **question** in the input
4. Click **"Ask Question"** button
5. Agent responds with text in bubble below

This demonstrates the supervisor intervention flow without using voice.

---

## ğŸ” Security Notes

### Token-Based Authentication
- Every connection requires a valid JWT token
- Token generated by backend using LiveKit API keys
- Token includes identity, room name, and permissions
- Tokens expire (check backend configuration)

### Permissions
- Microphone access required for voice
- Browser enforces HTTPS for production
- localhost is exempt from HTTPS requirement

---

## ğŸš€ Production Deployment

For production use:

### 1. Update Environment Variables
```bash
# Backend .env
LIVEKIT_API_KEY=your-api-key
LIVEKIT_API_SECRET=your-secret
LIVEKIT_URL=wss://your-livekit-server.com
```

### 2. Use HTTPS
- Voice/video requires secure context in production
- Use SSL certificate for your domain
- Configure LiveKit server with valid cert

### 3. Network Requirements
- Open WebRTC ports (UDP typically)
- Configure TURN servers for NAT traversal
- Test across different networks

---

## ğŸ“Š Events Tracked

The component logs these events:

| Event | Description |
|-------|-------------|
| Connected | Successfully joined room |
| Disconnected | Left room or connection lost |
| Reconnecting | Temporary connection issue |
| Reconnected | Recovered from disconnection |
| TrackSubscribed | Agent audio track received |
| TrackUnsubscribed | Agent audio track removed |
| ParticipantConnected | New person joined room |
| ParticipantDisconnected | Person left room |

---

## ğŸ¨ UI States

### Not Connected
- Identity and Room inputs enabled
- "ğŸ¤ Join Voice Room" button (primary/blue)
- No status message

### Connected
- Identity and Room inputs disabled
- "ğŸ“ Leave" button (red)
- "ğŸ¤ Mute" button (green) or "ğŸ”‡ Unmute" (red)
- "ğŸ¤ Connected â€¢ Room: frontdesk-demo" (green status)
- "Ask Question" form visible

### Reconnecting
- All buttons disabled
- "ğŸ”„ Reconnecting..." (gray status)

---

## ğŸ’¡ Tips for Best Experience

1. **Use Headphones** - Prevents echo/feedback
2. **Good Microphone** - Clear audio quality
3. **Stable Internet** - 1+ Mbps recommended
4. **Quiet Environment** - Reduces background noise
5. **Browser Console Open** - Monitor connection health

---

## ğŸ“ Example Workflow

### Scenario: Supervisor joins to monitor agent

1. **Open application** â†’ http://localhost:5173/
2. **Set identity** â†’ "supervisor-1"
3. **Set room** â†’ "frontdesk-demo"
4. **Click Join** â†’ Microphone permission granted
5. **See "Connected"** â†’ Green status indicator
6. **Agent speaks** â†’ Hear through speakers
7. **Supervisor speaks** â†’ Microphone transmits
8. **Need to mute?** â†’ Click "ğŸ¤ Mute"
9. **Done monitoring?** â†’ Click "ğŸ“ Leave"

---

## ğŸ”§ Technical Implementation

### Key Components

**LiveKit Room**
- WebRTC-based real-time communication
- Handles audio/video tracks
- Manages participant connections
- Automatic reconnection logic

**Microphone Track**
- Captured via `getUserMedia()`
- Published to room automatically
- Can be muted/unmuted without republishing

**Remote Audio Tracks**
- Subscribed automatically when available
- Attached to DOM audio elements
- Auto-play with fallback for user interaction

---

## âœ… Success Indicators

You'll know voice is working when:

1. âœ… Status shows "ğŸ¤ Connected" in green
2. âœ… Console logs "âœ… Connected to LiveKit room"
3. âœ… Console logs "ğŸ™ï¸ Microphone enabled"
4. âœ… You hear agent's voice
5. âœ… Agent can hear you (verify with backend logs)

---

## ğŸ“š Additional Resources

- **LiveKit Docs**: https://docs.livekit.io/
- **WebRTC Troubleshooting**: https://webrtc.github.io/samples/
- **Browser Compatibility**: https://caniuse.com/webrtc

---

## ğŸ‰ You're Ready to Use Voice!

The voice feature is now fully functional. Simply:
1. Join a room
2. Grant microphone permission
3. Start talking with the agent!

For any issues, check the troubleshooting section or browser console logs.

---

**Last Updated**: October 20, 2025  
**Status**: âœ… Voice Integration Complete  
**Version**: 1.0 with LiveKit Client SDK
