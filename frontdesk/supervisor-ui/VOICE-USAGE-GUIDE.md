# 🎤 LiveKit Voice Integration - User Guide

## ✅ Voice Feature Now Enabled!

The LiveKit panel now has **full voice integration** with real-time audio communication.

---

## 🚀 How to Use Voice

### Step 1: Open the Application
Navigate to http://localhost:5173/

### Step 2: Locate the LiveKit Panel
The voice controls are in the **top navigation bar** (TopNav component)

### Step 3: Configure Connection
- **Identity**: Enter your name/identifier (e.g., "supervisor-1")
- **Room**: Enter the LiveKit room name (e.g., "frontdesk-demo")

### Step 4: Join Voice Room
1. Click **"🎤 Join Voice Room"** button
2. Browser will request **microphone permission** - click **Allow**
3. Wait for connection (you'll see "🎤 Connected • Room: frontdesk-demo")

### Step 5: Start Talking!
- Your microphone is automatically enabled
- The agent in the room will hear you
- You will hear the agent's voice through your speakers

---

## 🎛️ Voice Controls

### Join Voice Room (🎤)
- Connects to LiveKit server using backend token
- Enables your microphone
- Subscribes to agent's audio

### Leave (📞)
- Disconnects from room
- Stops microphone
- Clears connection

### Mute (🎤 / 🔇)
- **Green background** = Microphone ON
- **Red background** = Microphone MUTED
- Toggle anytime during call

---

## 🔊 Audio Features Implemented

### Microphone (Your Voice)
✅ Automatic microphone capture on join  
✅ Mute/unmute toggle  
✅ Audio published to LiveKit room  
✅ Agent can hear you in real-time  

### Speaker (Agent's Voice)
✅ Automatic subscription to agent's audio tracks  
✅ Audio attached to hidden `<audio>` element  
✅ Auto-play agent responses  
✅ Real-time voice streaming  

### Connection Management
✅ Connection state tracking  
✅ Automatic reconnection on network issues  
✅ Visual feedback (Connected/Reconnecting)  
✅ Participant join/leave events  

---

## 🎯 What Happens When You Join

```
1. Click "Join Voice Room"
   ↓
2. Frontend calls backend: GET /livekit/token?identity=...&room=...
   ↓
3. Backend returns: { token, url, identity, room }
   ↓
4. Frontend creates LiveKit Room instance
   ↓
5. Connects to LiveKit server with token
   ↓
6. Enables microphone (publishes audio track)
   ↓
7. Subscribes to remote audio tracks (agent)
   ↓
8. You can talk and hear the agent!
```

---

## 🐛 Troubleshooting

### Problem: "Microphone permission denied"
**Solution:**
- Check browser permissions (Settings → Privacy → Microphone)
- Reload page and try again
- Make sure you're on HTTPS or localhost

### Problem: "Can't hear agent"
**Solution:**
1. Check speaker volume
2. Verify agent is connected to the room
3. Look for "Track subscribed: audio" in browser console (F12)
4. Try clicking page if autoplay is blocked

### Problem: "Connection failed"
**Solution:**
1. Verify backend is running (http://localhost:8000)
2. Check that LiveKit server is running on backend
3. Look at browser console for error details
4. Verify token endpoint returns valid data

### Problem: "Audio playback blocked"
**Solution:**
- Browser may block autoplay
- Click anywhere on the page to enable audio
- You'll see: "🔊 Click anywhere to enable audio playback"

---

## 🔍 Debugging Tips

### Open Browser Console (F12)
Look for these log messages:

**✅ Success Messages:**
```
✅ Connected to LiveKit room
🎙️ Microphone enabled
📻 Track subscribed: audio from agent-voice
🔊 Agent audio track attached and playing
```

**❌ Error Messages:**
```
❌ Failed to join room: [error details]
Audio autoplay failed: [error details]
```

### Check Connection State
The status indicator shows:
- **🎤 Connected** (green) = Voice working
- **🔄 Reconnecting** (gray) = Temporary issue
- No message = Not connected

### Verify Backend Token
Test token endpoint manually:
```bash
curl "http://localhost:8000/livekit/token?identity=test&room=demo"
```

Should return:
```json
{
  "token": "eyJhbGc...",
  "url": "wss://livekit-server:7880",
  "identity": "test",
  "room": "demo"
}
```

---

## 📋 Voice Feature Checklist

Before using voice, ensure:

- [ ] Backend is running (`http://localhost:8000`)
- [ ] LiveKit server is running on backend
- [ ] Frontend dev server is running (`http://localhost:5173`)
- [ ] Browser supports WebRTC (Chrome, Firefox, Edge, Safari)
- [ ] Microphone is connected
- [ ] Speakers/headphones are connected
- [ ] Microphone permissions granted

---

## 🎙️ Text-Based "Ask Question" Feature

In addition to voice, there's a **text-based HITL demonstration**:

1. Join voice room first
2. Enter **Customer ID** (e.g., "demo-1")
3. Type a **question** in the input
4. Click **"Ask Question"** button
5. Agent responds with text in bubble below

This demonstrates the supervisor intervention flow without using voice.

---

## 🔐 Security Notes

### Token-Based Authentication
- Every connection requires a valid JWT token
- Token generated by backend using LiveKit API keys
- Token includes identity, room name, and permissions
- Tokens expire (check backend configuration)

### Permissions
- Microphone access required for voice
- Browser enforces HTTPS for production
- localhost is exempt from HTTPS requirement

---

## 🚀 Production Deployment

For production use:

### 1. Update Environment Variables
```bash
# Backend .env
LIVEKIT_API_KEY=your-api-key
LIVEKIT_API_SECRET=your-secret
LIVEKIT_URL=wss://your-livekit-server.com
```

### 2. Use HTTPS
- Voice/video requires secure context in production
- Use SSL certificate for your domain
- Configure LiveKit server with valid cert

### 3. Network Requirements
- Open WebRTC ports (UDP typically)
- Configure TURN servers for NAT traversal
- Test across different networks

---

## 📊 Events Tracked

The component logs these events:

| Event | Description |
|-------|-------------|
| Connected | Successfully joined room |
| Disconnected | Left room or connection lost |
| Reconnecting | Temporary connection issue |
| Reconnected | Recovered from disconnection |
| TrackSubscribed | Agent audio track received |
| TrackUnsubscribed | Agent audio track removed |
| ParticipantConnected | New person joined room |
| ParticipantDisconnected | Person left room |

---

## 🎨 UI States

### Not Connected
- Identity and Room inputs enabled
- "🎤 Join Voice Room" button (primary/blue)
- No status message

### Connected
- Identity and Room inputs disabled
- "📞 Leave" button (red)
- "🎤 Mute" button (green) or "🔇 Unmute" (red)
- "🎤 Connected • Room: frontdesk-demo" (green status)
- "Ask Question" form visible

### Reconnecting
- All buttons disabled
- "🔄 Reconnecting..." (gray status)

---

## 💡 Tips for Best Experience

1. **Use Headphones** - Prevents echo/feedback
2. **Good Microphone** - Clear audio quality
3. **Stable Internet** - 1+ Mbps recommended
4. **Quiet Environment** - Reduces background noise
5. **Browser Console Open** - Monitor connection health

---

## 📞 Example Workflow

### Scenario: Supervisor joins to monitor agent

1. **Open application** → http://localhost:5173/
2. **Set identity** → "supervisor-1"
3. **Set room** → "frontdesk-demo"
4. **Click Join** → Microphone permission granted
5. **See "Connected"** → Green status indicator
6. **Agent speaks** → Hear through speakers
7. **Supervisor speaks** → Microphone transmits
8. **Need to mute?** → Click "🎤 Mute"
9. **Done monitoring?** → Click "📞 Leave"

---

## 🔧 Technical Implementation

### Key Components

**LiveKit Room**
- WebRTC-based real-time communication
- Handles audio/video tracks
- Manages participant connections
- Automatic reconnection logic

**Microphone Track**
- Captured via `getUserMedia()`
- Published to room automatically
- Can be muted/unmuted without republishing

**Remote Audio Tracks**
- Subscribed automatically when available
- Attached to DOM audio elements
- Auto-play with fallback for user interaction

---

## ✅ Success Indicators

You'll know voice is working when:

1. ✅ Status shows "🎤 Connected" in green
2. ✅ Console logs "✅ Connected to LiveKit room"
3. ✅ Console logs "🎙️ Microphone enabled"
4. ✅ You hear agent's voice
5. ✅ Agent can hear you (verify with backend logs)

---

## 📚 Additional Resources

- **LiveKit Docs**: https://docs.livekit.io/
- **WebRTC Troubleshooting**: https://webrtc.github.io/samples/
- **Browser Compatibility**: https://caniuse.com/webrtc

---

## 🎉 You're Ready to Use Voice!

The voice feature is now fully functional. Simply:
1. Join a room
2. Grant microphone permission
3. Start talking with the agent!

For any issues, check the troubleshooting section or browser console logs.

---

**Last Updated**: October 20, 2025  
**Status**: ✅ Voice Integration Complete  
**Version**: 1.0 with LiveKit Client SDK
